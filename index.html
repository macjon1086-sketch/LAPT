<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loan Application Dashboard</title>

  <!-- Global & feature styles -->
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="newApps.css">
  <link rel="stylesheet" href="viewApps.css">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Font Awesome (kept from original) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
  <!-- Main app markup (adapted from the Apps Script project) -->
  <div class="top-menu">
    <div class="menu-left">
      <button class="add-app-btn" onclick="showNewApplicationModal()">
        <i class="fas fa-plus"></i> Add New Application
      </button>
    </div>
    <div class="app-title">
      <i class="fas fa-layer-group"></i> LOAN APPLICATION TRACKER
    </div>
    <div class="user-info">
      <span class="date-display" id="current-date"></span>
      <div class="user-notification-container">
        <span id="logged-in-user"></span>
        <span id="user-notification-badge" class="notification-badge"></span>
      </div>
      <button class="logout-btn" onclick="logout()" title="Logout">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </div>

  <div class="container">
    <div class="side-menu">
      <div class="menu-section">
        <div class="menu-title"><i class="fas fa-tasks"></i> Applications</div>
        <button class="menu-btn" onclick="showSection('new')">
          <i class="fas fa-file-alt"></i> New <span class="badge" id="new-count">0</span>
        </button>
        <button class="menu-btn active" onclick="showSection('pending')">
          <i class="fas fa-clock"></i> Pending <span class="badge" id="pending-count">0</span>
        </button>
        <button class="menu-btn" onclick="showSection('pending-approvals')">
          <i class="fas fa-hourglass-half"></i> Pending Approvals <span class="badge" id="pending-approvals-count">0</span>
        </button>
        <button class="menu-btn" onclick="showSection('approved')">
          <i class="fas fa-check-circle"></i> Approved <span class="badge" id="approved-count">0</span>
        </button>
      </div>

      <div class="menu-section">
        <div class="menu-title"><i class="fas fa-users"></i> User Management</div>
        <button class="menu-btn" onclick="showSection('add-user')">
          <i class="fas fa-user-plus"></i> Add User
        </button>
        <button class="menu-btn" onclick="showSection('users-list')">
          <i class="fas fa-list"></i> Users List
        </button>
      </div>
    </div>

    <div class="main-content">
      <div id="new" class="content-section">
        <div class="section-header">
          <h2><i class="fas fa-file-alt"></i> New Applications</h2>
          <div class="section-actions">
            <button class="btn-outline" onclick="refreshApplications()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
        <div class="table-container">
          <table class="applications-table">
            <thead>
              <tr>
                <th>Application Number</th>
                <th>Applicant Name</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Action By</th>
              </tr>
            </thead>
            <tbody id="new-list">
              <tr><td colspan="5" class="loading">Loading applications...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="pending" class="content-section">
        <div class="section-header">
          <h2><i class="fas fa-clock"></i> Pending Applications</h2>
          <div class="section-actions">
            <button class="btn-outline" onclick="refreshApplications()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
        <div class="table-container">
          <table class="applications-table">
            <thead>
              <tr>
                <th>Application Number</th>
                <th>Applicant Name</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Action By</th>
              </tr>
            </thead>
            <tbody id="pending-list">
              <tr><td colspan="5" class="loading">Loading applications...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="pending-approvals" class="content-section">
        <div class="section-header">
          <h2><i class="fas fa-hourglass-half"></i> Pending Approvals</h2>
          <div class="section-actions">
            <button class="btn-outline" onclick="refreshApplications()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
        <div class="table-container">
          <table class="applications-table">
            <thead>
              <tr>
                <th>Application Number</th>
                <th>Applicant Name</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Action By</th>
              </tr>
            </thead>
            <tbody id="pending-approvals-list">
              <tr><td colspan="5" class="loading">Loading applications...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="approved" class="content-section">
        <div class="section-header">
          <h2><i class="fas fa-check-circle"></i> Approved Applications</h2>
          <div class="section-actions">
            <button class="btn-outline" onclick="refreshApplications()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
        <div class="table-container">
          <table class="applications-table">
            <thead>
              <tr>
                <th>Application Number</th>
                <th>Applicant Name</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Action By</th>
              </tr>
            </thead>
            <tbody id="approved-list">
              <tr><td colspan="5" class="loading">Loading applications...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Application Details area (kept empty because view modal is separate) -->
      <div id="application-details" class="content-section">
        <div class="section-header">
          <h2><i class="fas fa-file-alt"></i> Application Details</h2>
          <div class="section-actions">
            <button class="btn-secondary" onclick="goBackToList()">
              <i class="fas fa-arrow-left"></i> Back to List
            </button>
          </div>
        </div>
        <div class="app-details-container" id="app-details-content">
          <!-- Application details will be loaded into the view modal rather than inline -->
        </div>
      </div>

      <!-- Add User -->
      <div id="add-user" class="content-section">
        <div class="section-header">
          <h2><i class="fas fa-user-plus"></i> Add User</h2>
        </div>
        <div class="form-container">
          <form id="add-user-form">
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" class="form-input" id="new-user-name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Level *</label>
              <input type="number" class="form-input" id="new-user-level" required min="1">
            </div>
            <div class="form-group">
              <label class="form-label">Role *</label>
              <select class="form-input" id="new-user-role" required>
                <option value="">Select Role</option>
                <option value="Credit Sales Officer">Credit Sales Officer</option>
                <option value="Credit Analyst">Credit Analyst</option>
                <option value="AMLRO">AMLRO</option>
                <option value="Head of Credit">Head of Credit</option>
                <option value="Branch Manager/Approver">Branch Manager/Approver</option>
                <option value="Approver">Approver</option>
                <option value="Admin">Admin</option>
              </select>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" onclick="showSection('users-list')">Cancel</button>
              <button type="submit" class="btn-primary">Add User</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Users List -->
      <div id="users-list" class="content-section">
        <div class="section-header">
          <h2><i class="fas fa-list"></i> Users List</h2>
          <div class="section-actions">
            <button class="btn-outline" onclick="refreshUsersList()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
        <div class="table-container">
          <table class="applications-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Level</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-list-body">
              <tr><td colspan="4" class="loading">Loading users...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div><!-- /main-content -->
  </div><!-- /container -->

  <!-- Modal placeholders (will be injected at runtime) -->
  <!-- newApps.html and viewApps.html will be loaded and appended to the body -->
  <div id="modals-placeholder" style="display:none"></div>

  <!-- Loading & success overlays -->
  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p>Processing...</p>
  </div>

  <div id="success-modal" class="modal-overlay">
    <div class="modal-message">
      <i class="fas fa-check-circle success-icon"></i>
      <div id="success-message"></div>
      <button onclick="closeSuccessModal()" class="btn-primary">OK</button>
    </div>
  </div>

  <!-- Load modal HTML then main scripts (dynamic loader) -->
  <script>
    (async function() {
      // Inject modal fragments into the page before loading main app scripts.
      // This helps the scripts find modal elements on initialization.
      const modalFiles = ['newApps.html', 'viewApps.html'];
      for (const mf of modalFiles) {
        try {
          const res = await fetch(mf);
          if (res.ok) {
            const text = await res.text();
            // append to body
            document.body.insertAdjacentHTML('beforeend', text);
          } else {
            console.warn('Failed to load modal file:', mf, res.status);
          }
        } catch (e) {
          console.warn('Error fetching modal file:', mf, e);
        }
      }

      // After modal fragments are in DOM, load main JS files.
      const scriptFiles = ['api.js', 'newApps.js', 'viewApps.js'];
      for (const s of scriptFiles) {
        const tag = document.createElement('script');
        tag.src = s;
        document.body.appendChild(tag);
        // allow scripts to execute in order by awaiting small next-tick delay
        await new Promise(r => setTimeout(r, 8));
      }
    })();
  </script>
</body>
</html>
